<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Matching Service – Minimal Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
        h1 { margin: 0 0 8px; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; margin-top: 16px; }
        .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; min-width: 280px; }
        label { display:block; font-size: 12px; color:#555; margin-top: 8px; }
        input, select, button { margin-top: 6px; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
        button { cursor: pointer; }
        .log { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background: #f7f7f7; padding: 10px; border-radius: 8px; height: 140px; overflow:auto; white-space: pre-wrap; }
        .ok { color: #0a7; }
        .warn { color: #a70; }
        .err { color: #b00; }
        .small { font-size: 12px; color:#777; }
    </style>
</head>
<body>
<h1>Matching Service – Minimal Demo</h1>
<div class="small">Service base: <code>http://localhost:4100</code></div>

<div class="row">
    <div class="card">
        <h3>User A</h3>
        <label>User ID</label>
        <input id="userA" value="alice" />
        <label>Difficulty</label>
        <select id="diffA">
            <option>EASY</option>
            <option selected>MEDIUM</option>
            <option>HARD</option>
        </select>
        <label>Topic</label>
        <input id="topicA" value="Graphs" />
        <button onclick="startMatching('A')">Start Matching</button>

        <label class="small">Last requestId</label>
        <input id="reqA" readonly />
        <button onclick="pollStatus('A')">Poll Status</button>
    </div>

    <div class="card">
        <h3>User B</h3>
        <label>User ID</label>
        <input id="userB" value="bob" />
        <label>Difficulty</label>
        <select id="diffB">
            <option>EASY</option>
            <option selected>MEDIUM</option>
            <option>HARD</option>
        </select>
        <label>Topic</label>
        <input id="topicB" value="Graphs" />
        <button onclick="startMatching('B')">Start Matching</button>

        <label class="small">Last requestId</label>
        <input id="reqB" readonly />
        <button onclick="pollStatus('B')">Poll Status</button>
    </div>

    <div class="card" style="flex:1 1 360px;">
        <h3>Log</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>
</div>

<script>
    const BASE = ""; // served from same origin (http://localhost:4100)

    function log(msg, cls) {
        const el = document.getElementById('log');
        const line = document.createElement('div');
        if (cls) line.className = cls;
        const now = new Date().toLocaleTimeString();
        line.textContent = `[${now}] ${msg}`;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
    }
    function clearLog(){ document.getElementById('log').innerHTML=''; }

    async function startMatching(which) {
        const uid = document.getElementById('user' + which).value.trim();
        const difficulty = document.getElementById('diff' + which).value.trim();
        const topic = document.getElementById('topic' + which).value.trim();

        if (!uid || !difficulty || !topic) {
            log(`(${which}) Missing fields.`, 'warn');
            return;
        }

        try {
            const res = await fetch(`${BASE}/api/matching/matches`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-Id': uid
                },
                body: JSON.stringify({ difficulty, topic })
            });

            const data = await res.json();
            if (!res.ok) {
                log(`(${which}) Error ${res.status}: ${JSON.stringify(data)}`, 'err');
                return;
            }

            document.getElementById('req' + which).value = data.requestId || '';
            log(`(${which}) ${data.status} ${data.counterpartReqId ? '(paired with ' + data.counterpartReqId + ')' : ''}`, data.status === 'MATCHED' ? 'ok' : 'warn');
        } catch (e) {
            log(`(${which}) Network error: ${e}`, 'err');
        }
    }

    async function pollStatus(which) {
        const reqId = document.getElementById('req' + which).value.trim();
        if (!reqId) { log(`(${which}) No requestId to poll.`, 'warn'); return; }

        try {
            const res = await fetch(`${BASE}/api/matching/matches/${reqId}`);
            const data = await res.json();
            if (!res.ok) {
                log(`(${which}) Poll error ${res.status}: ${JSON.stringify(data)}`, 'err');
                return;
            }
            log(`(${which}) Status for ${reqId}: ${data.status}`, data.status === 'MATCHED' ? 'ok' : 'warn');
        } catch (e) {
            log(`(${which}) Network error (poll): ${e}`, 'err');
        }
    }
</script>
</body>
</html>
